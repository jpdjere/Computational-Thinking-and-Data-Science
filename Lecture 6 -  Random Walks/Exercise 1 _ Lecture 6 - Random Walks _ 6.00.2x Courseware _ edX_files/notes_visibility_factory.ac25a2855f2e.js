/*
** Annotator v1.2.9
** https://github.com/okfn/annotator/
**
** Copyright 2013, the Annotator project contributors.
** Dual licensed under the MIT and GPLv3 licenses.
** https://github.com/okfn/annotator/blob/master/LICENSE
**
** Built at: 2013-12-02 17:58:01Z
 */

(function(){var t=function(){return{gettext:gettext}};return!function(){var e,n,o,i,r,s,a,u,l,h,d,c,p,f,g,m,y,v,w,b,_,T,E,x,A,C,S,k,N=[].slice,F={}.hasOwnProperty,D=function(t,e){function n(){this.constructor=t}for(var o in e)F.call(e,o)&&(t[o]=e[o]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},O=function(t,e){return function(){return t.apply(e,arguments)}},P=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1};if(v=function(t){var n;return n=this.map(function(){var n,o,i,r;for(i="",n=this;(null!=n?n.nodeType:void 0)===Node.ELEMENT_NODE&&n!==t;)r=n.tagName.replace(":","\\:"),o=e(n.parentNode).children(r).index(n)+1,o="["+o+"]",i="/"+n.tagName.toLowerCase()+o+i,n=n.parentNode;return i}),n.get()},w=function(t){var e,n,o,i;return e=function(t){var e,n;return e=f(t),n=g(t),""+e+"["+n+"]"},i=t,n=function(t){var n;for(n="";t!==i;){if(null==t)throw new Error("Called getPathTo on a node which was not a descendant of @rootNode. "+i);n=e(t)+"/"+n,t=t.parentNode}return n="/"+n,n=n.replace(/\/$/,"")},o=this.map(function(){var t;return t=n(this)}),o.get()},h=function(t,e,n){var o,i,r,s,a,u;if(!t.hasChildNodes())throw new Error("XPath error: node has no children!");for(i=t.childNodes,r=0,a=0,u=i.length;u>a;a++)if(o=i[a],s=f(o),s===e&&(r+=1,r===n))return o;throw new Error("XPath error: wanted child not found.")},f=function(t){var e;switch(e=t.nodeName.toLowerCase()){case"#text":return"text()";case"#comment":return"comment()";case"#cdata-section":return"cdata-section()";default:return e}},g=function(t){var e,n;for(e=0,n=t;n;)n.nodeName===t.nodeName&&e++,n=n.previousSibling;return e},m=null,"undefined"!=typeof t&&null!==t?(_=new t({domain:"annotator"}),m=function(t){return _.gettext(t)}):m=function(t){return t},k=function(t){return m(t)},("undefined"!=typeof jQuery&&null!==jQuery?null!=(C=jQuery.fn)?C.jquery:void 0:void 0)||console.error(k("Annotator requires jQuery: have you included lib/vendor/jquery.js?")),JSON&&JSON.parse&&JSON.stringify||console.error(k("Annotator requires a JSON implementation: have you included lib/vendor/json2.js?")),e=jQuery,s={},s.flatten=function(t){var n;return(n=function(t){var o,i,r,s;for(i=[],r=0,s=t.length;s>r;r++)o=t[r],i=i.concat(o&&e.isArray(o)?n(o):o);return i})(t)},s.contains=function(t,e){var n;for(n=e;null!=n;){if(n===t)return!0;n=n.parentNode}return!1},s.getTextNodes=function(t){var e;return e=function(t){var n;if(t&&t.nodeType!==Node.TEXT_NODE){if(n=[],t.nodeType!==Node.COMMENT_NODE)for(t=t.lastChild;t;)n.push(e(t)),t=t.previousSibling;return n.reverse()}return t},t.map(function(){return s.flatten(e(this))})},s.getLastTextNodeUpTo=function(t){var e;switch(t.nodeType){case Node.TEXT_NODE:return t;case Node.ELEMENT_NODE:if(null!=t.lastChild&&(e=s.getLastTextNodeUpTo(t.lastChild),null!=e))return e}return t=t.previousSibling,null!=t?s.getLastTextNodeUpTo(t):null},s.getFirstTextNodeNotBefore=function(t){var e;switch(t.nodeType){case Node.TEXT_NODE:return t;case Node.ELEMENT_NODE:if(null!=t.firstChild&&(e=s.getFirstTextNodeNotBefore(t.firstChild),null!=e))return e}return t=t.nextSibling,null!=t?s.getFirstTextNodeNotBefore(t):null},s.readRangeViaSelection=function(t){var e;return e=s.getGlobal().getSelection(),e.removeAllRanges(),e.addRange(t.toRange()),e.toString()},s.xpathFromNode=function(t,e){var n,o;try{o=v.call(t,e)}catch(i){n=i,console.log("jQuery-based XPath construction failed! Falling back to manual."),o=w.call(t,e)}return o},s.nodeFromXPath=function(t,e){var n,o,i,r,s,a,u,l;for(s=t.substring(1).split("/"),i=e,a=0,u=s.length;u>a;a++)r=s[a],l=r.split("["),o=l[0],n=l[1],n=null!=n?parseInt((null!=n?n.split("]"):void 0)[0]):1,i=h(i,o.toLowerCase(),n);return i},s.escape=function(t){return t.replace(/&(?!\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},s.uuid=function(){var t;return t=0,function(){return t++}}(),s.getGlobal=function(){return function(){return this}()},s.maxZIndex=function(t){var n,o;return n=function(){var n,i,r;for(r=[],n=0,i=t.length;i>n;n++)o=t[n],r.push("static"===e(o).css("position")?-1:parseInt(e(o).css("z-index"),10)||-1);return r}(),Math.max.apply(Math,n)},s.mousePosition=function(t,n){var o,i;return"absolute"!==(i=e(n).css("position"))&&"fixed"!==i&&"relative"!==i&&(n=e(n).offsetParent()[0]),o=e(n).offset(),{top:t.pageY-o.top,left:t.pageX-o.left}},s.preventEventDefault=function(t){return null!=t?"function"==typeof t.preventDefault?t.preventDefault():void 0:void 0},c=["log","debug","info","warn","exception","assert","dir","dirxml","trace","group","groupEnd","groupCollapsed","time","timeEnd","profile","profileEnd","count","clear","table","error","notifyFirebug","firebug","userObjects"],"undefined"!=typeof console&&null!==console)for(null==console.group&&(console.group=function(t){return console.log("GROUP: ",t)}),null==console.groupCollapsed&&(console.groupCollapsed=console.group),T=0,x=c.length;x>T;T++)d=c[T],null==console[d]&&(console[d]=function(){return console.log(k("Not implemented:")+(" console."+name))});else{for(this.console={},E=0,A=c.length;A>E;E++)d=c[E],this.console[d]=function(){};this.console.error=function(){var t;return t=1<=arguments.length?N.call(arguments,0):[],alert("ERROR: "+t.join(", "))},this.console.warn=function(){var t;return t=1<=arguments.length?N.call(arguments,0):[],alert("WARNING: "+t.join(", "))}}o=function(){function t(t,n){this.options=e.extend(!0,{},this.options,n),this.element=e(t),this._closures={},this.on=this.subscribe,this.addEvents()}return t.prototype.events={},t.prototype.options={},t.prototype.element=null,t.prototype.addEvents=function(){var e,n,o,i,r;for(i=t._parseEvents(this.events),r=[],n=0,o=i.length;o>n;n++)e=i[n],r.push(this._addEvent(e.selector,e.event,e.functionName));return r},t.prototype.removeEvents=function(){var e,n,o,i,r;for(i=t._parseEvents(this.events),r=[],n=0,o=i.length;o>n;n++)e=i[n],r.push(this._removeEvent(e.selector,e.event,e.functionName));return r},t.prototype._addEvent=function(e,n,o){var i;return i=function(t){return function(){return t[o].apply(t,arguments)}}(this),""===e&&t._isCustomEvent(n)?this.subscribe(n,i):this.element.delegate(e,n,i),this._closures[""+e+"/"+n+"/"+o]=i,this},t.prototype._removeEvent=function(e,n,o){var i;return i=this._closures[""+e+"/"+n+"/"+o],""===e&&t._isCustomEvent(n)?this.unsubscribe(n,i):this.element.undelegate(e,n,i),delete this._closures[""+e+"/"+n+"/"+o],this},t.prototype.publish=function(){return this.element.triggerHandler.apply(this.element,arguments),this},t.prototype.subscribe=function(t,n){var o;return o=function(){return n.apply(this,[].slice.call(arguments,1))},o.guid=n.guid=e.guid+=1,this.element.bind(t,o),this},t.prototype.unsubscribe=function(){return this.element.unbind.apply(this.element,arguments),this},t}(),o._parseEvents=function(t){var e,n,o,i,r,s,a;n=[];for(i in t)o=t[i],a=i.split(" "),r=2<=a.length?N.call(a,0,s=a.length-1):(s=0,[]),e=a[s++],n.push({selector:r.join(" "),event:e,functionName:o});return n},o.natives=function(){var t,e,n;return e=function(){var e,o;e=jQuery.event.special,o=[];for(t in e)F.call(e,t)&&(n=e[t],o.push(t));return o}(),"blur focus focusin focusout load resize scroll unload click dblclick\nmousedown mouseup mousemove mouseover mouseout mouseenter mouseleave\nchange select submit keydown keypress keyup error".split(/[^a-z]+/).concat(e)}(),o._isCustomEvent=function(t){return t=t.split(".")[0],-1===e.inArray(t,o.natives)},r={},r.sniff=function(t){return null!=t.commonAncestorContainer?new r.BrowserRange(t):"string"==typeof t.start?new r.SerializedRange(t):t.start&&"object"==typeof t.start?new r.NormalizedRange(t):(console.error(k("Could not sniff range type")),!1)},r.nodeFromXPath=function(t,n){var o,i,r,a,u;return null==n&&(n=document),i=function(t,e){var o;null==e&&(e=null);try{return document.evaluate("."+t,n,e,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue}catch(i){return o=i,console.log("XPath evaluation failed."),console.log("Trying fallback..."),s.nodeFromXPath(t,n)}},e.isXMLDoc(document.documentElement)?(o=document.createNSResolver(null===document.ownerDocument?document.documentElement:document.ownerDocument.documentElement),a=i(t,o),a||(t=function(){var e,n,o,i;for(o=t.split("/"),i=[],e=0,n=o.length;n>e;e++)u=o[e],i.push(u&&-1===u.indexOf(":")?u.replace(/^([a-z]+)/,"xhtml:$1"):u);return i}().join("/"),r=document.lookupNamespaceURI(null),o=function(t){return"xhtml"===t?r:document.documentElement.getAttribute("xmlns:"+t)},a=i(t,o)),a):i(t)},r.RangeError=function(t){function e(t,n,o){this.type=t,this.message=n,this.parent=null!=o?o:null,e.__super__.constructor.call(this,this.message)}return D(e,t),e}(Error),r.BrowserRange=function(){function t(t){this.commonAncestorContainer=t.commonAncestorContainer,this.startContainer=t.startContainer,this.startOffset=t.startOffset,this.endContainer=t.endContainer,this.endOffset=t.endOffset}return t.prototype.normalize=function(){var t,e,n,o;if(this.tainted)return console.error(k("You may only call normalize() once on a BrowserRange!")),!1;if(this.tainted=!0,o={},this.startContainer.nodeType===Node.ELEMENT_NODE?(o.start=s.getFirstTextNodeNotBefore(this.startContainer.childNodes[this.startOffset]),o.startOffset=0):(o.start=this.startContainer,o.startOffset=this.startOffset),this.endContainer.nodeType===Node.ELEMENT_NODE){if(e=this.endContainer.childNodes[this.endOffset],null!=e){for(t=e;null!=t&&t.nodeType!==Node.TEXT_NODE;)t=t.firstChild;null!=t&&(o.end=t,o.endOffset=0)}null==o.end&&(e=this.endContainer.childNodes[this.endOffset-1],o.end=s.getLastTextNodeUpTo(e),o.endOffset=o.end.nodeValue.length)}else o.end=this.endContainer,o.endOffset=this.endOffset;for(n={},n.start=o.startOffset>0?o.start.nodeValue.length>o.startOffset?o.start.splitText(o.startOffset):o.start.nextSibling:o.start,o.start===o.end?(n.start.nodeValue.length>o.endOffset-o.startOffset&&n.start.splitText(o.endOffset-o.startOffset),n.end=n.start):(o.end.nodeValue.length>o.endOffset&&o.end.splitText(o.endOffset),n.end=o.end),n.commonAncestor=this.commonAncestorContainer;n.commonAncestor.nodeType!==Node.ELEMENT_NODE;)n.commonAncestor=n.commonAncestor.parentNode;return new r.NormalizedRange(n)},t.prototype.serialize=function(t,e){return this.normalize(t).serialize(t,e)},t}(),r.NormalizedRange=function(){function t(t){this.commonAncestor=t.commonAncestor,this.start=t.start,this.end=t.end}return t.prototype.normalize=function(){return this},t.prototype.limit=function(t){var n,o,i,r,s,a;if(n=e.grep(this.textNodes(),function(n){return n.parentNode===t||e.contains(t,n.parentNode)}),!n.length)return null;for(this.start=n[0],this.end=n[n.length-1],i=e(this.start).parents(),a=e(this.end).parents(),r=0,s=a.length;s>r;r++)if(o=a[r],-1!==i.index(o)){this.commonAncestor=o;break}return this},t.prototype.serialize=function(t,n){var o,i,a;return i=function(o,i){var r,a,u,l,h,d,c,p;for(l=n?e(o).parents(":not("+n+")").eq(0):e(o).parent(),d=s.xpathFromNode(l,t)[0],h=s.getTextNodes(l),a=h.slice(0,h.index(o)),u=0,c=0,p=a.length;p>c;c++)r=a[c],u+=r.nodeValue.length;return i?[d,u+o.nodeValue.length]:[d,u]},a=i(this.start),o=i(this.end,!0),new r.SerializedRange({start:a[0],end:o[0],startOffset:a[1],endOffset:o[1]})},t.prototype.text=function(){var t;return function(){var e,n,o,i;for(o=this.textNodes(),i=[],e=0,n=o.length;n>e;e++)t=o[e],i.push(t.nodeValue);return i}.call(this).join("")},t.prototype.textNodes=function(){var t,n,o,i;return o=s.getTextNodes(e(this.commonAncestor)),i=[o.index(this.start),o.index(this.end)],n=i[0],t=i[1],e.makeArray(o.slice(n,+t+1||9e9))},t.prototype.toRange=function(){var t;return t=document.createRange(),t.setStartBefore(this.start),t.setEndAfter(this.end),t},t}(),r.SerializedRange=function(){function t(t){this.start=t.start,this.startOffset=t.startOffset,this.end=t.end,this.endOffset=t.endOffset}return t.prototype.normalize=function(t){var n,o,i,a,u,l,h,d,c,p,f,g,m,y;for(l={},m=["start","end"],c=0,f=m.length;f>c;c++){u=m[c];try{a=r.nodeFromXPath(this[u],t)}catch(v){throw o=v,new r.RangeError(u,"Error while finding "+u+" node: "+this[u]+": "+o,o)}if(!a)throw new r.RangeError(u,"Couldn't find "+u+" node: "+this[u]);for(i=0,h=this[u+"Offset"],"end"===u&&h--,y=s.getTextNodes(e(a)),p=0,g=y.length;g>p;p++){if(d=y[p],i+d.nodeValue.length>h){l[u+"Container"]=d,l[u+"Offset"]=this[u+"Offset"]-i;break}i+=d.nodeValue.length}if(null==l[u+"Offset"])throw new r.RangeError(""+u+"offset","Couldn't find offset "+this[u+"Offset"]+" in element "+this[u])}return n=null==document.compareDocumentPosition?function(t,e){return t.contains(e)}:function(t,e){return 16&t.compareDocumentPosition(e)},e(l.startContainer).parents().each(function(){return n(this,l.endContainer)?(l.commonAncestorContainer=this,!1):void 0}),new r.BrowserRange(l).normalize(t)},t.prototype.serialize=function(t,e){return this.normalize(t).serialize(t,e)},t.prototype.toObject=function(){return{start:this.start,startOffset:this.startOffset,end:this.end,endOffset:this.endOffset}},t}(),b=this.Annotator,n=function(t){function n(){return this.onDeleteAnnotation=O(this.onDeleteAnnotation,this),this.onEditAnnotation=O(this.onEditAnnotation,this),this.onAdderClick=O(this.onAdderClick,this),this.onAdderMousedown=O(this.onAdderMousedown,this),this.onHighlightMouseover=O(this.onHighlightMouseover,this),this.checkForEndSelection=O(this.checkForEndSelection,this),this.checkForStartSelection=O(this.checkForStartSelection,this),this.clearViewerHideTimer=O(this.clearViewerHideTimer,this),this.startViewerHideTimer=O(this.startViewerHideTimer,this),this.showViewer=O(this.showViewer,this),this.onEditorSubmit=O(this.onEditorSubmit,this),this.onEditorHide=O(this.onEditorHide,this),this.showEditor=O(this.showEditor,this),n.__super__.constructor.apply(this,arguments),this.plugins={},n.supported()?(this.options.readOnly||this._setupDocumentEvents(),this._setupWrapper()._setupViewer()._setupEditor(),this._setupDynamicStyle(),this.adder=e(this.html.adder).appendTo(this.wrapper).hide(),void n._instances.push(this)):this}return D(n,t),n.prototype.events={".annotator-adder button click":"onAdderClick",".annotator-adder button mousedown":"onAdderMousedown",".annotator-hl mouseover":"onHighlightMouseover",".annotator-hl mouseout":"startViewerHideTimer"},n.prototype.html={adder:'<div class="annotator-adder"><button>'+k("Annotate")+"</button></div>",wrapper:'<div class="annotator-wrapper"></div>'},n.prototype.options={readOnly:!1},n.prototype.plugins={},n.prototype.editor=null,n.prototype.viewer=null,n.prototype.selectedRanges=null,n.prototype.mouseIsDown=!1,n.prototype.ignoreMouseup=!1,n.prototype.viewerHideTimer=null,n.prototype._setupWrapper=function(){return this.wrapper=e(this.html.wrapper),this.element.find("script").remove(),this.element.wrapInner(this.wrapper),this.wrapper=this.element.find(".annotator-wrapper"),this},n.prototype._setupViewer=function(){return this.viewer=new n.Viewer({readOnly:this.options.readOnly}),this.viewer.hide().on("edit",this.onEditAnnotation).on("delete",this.onDeleteAnnotation).addField({load:function(t){return function(n,o){return e(n).html(o.text?s.escape(o.text):"<i>"+k("No Comment")+"</i>"),t.publish("annotationViewerTextField",[n,o])}}(this)}).element.appendTo(this.wrapper).bind({mouseover:this.clearViewerHideTimer,mouseout:this.startViewerHideTimer}),this},n.prototype._setupEditor=function(){return this.editor=new n.Editor,this.editor.hide().on("hide",this.onEditorHide).on("save",this.onEditorSubmit).addField({type:"textarea",label:k("Comments")+"â€¦",load:function(t,n){return e(t).find("textarea").val(n.text||"")},submit:function(t,n){return n.text=e(t).find("textarea").val()}}),this.editor.element.appendTo(this.wrapper),this},n.prototype._setupDocumentEvents=function(){return e(document).bind({mouseup:this.checkForEndSelection,mousedown:this.checkForStartSelection}),this},n.prototype._setupDynamicStyle=function(){var t,n,o,i;return o=e("#annotator-dynamic-style"),o.length||(o=e('<style id="annotator-dynamic-style"></style>').appendTo(document.head)),n="*"+function(){var t,e,n,o;for(n=["adder","outer","notice","filter"],o=[],t=0,e=n.length;e>t;t++)i=n[t],o.push(":not(.annotator-"+i+")");return o}().join(""),t=s.maxZIndex(e(document.body).find(n)),t=Math.max(t,1e3),o.text([".annotator-adder, .annotator-outer, .annotator-notice {","  z-index: "+(t+20)+";","}",".annotator-filter {","  z-index: "+(t+10)+";","}"].join("\n")),this},n.prototype.destroy=function(){var t,o,i,r;e(document).unbind({mouseup:this.checkForEndSelection,mousedown:this.checkForStartSelection}),e("#annotator-dynamic-style").remove(),this.adder.remove(),this.viewer.destroy(),this.editor.destroy(),this.wrapper.find(".annotator-hl").each(function(){return e(this).contents().insertBefore(this),e(this).remove()}),this.wrapper.contents().insertBefore(this.wrapper),this.wrapper.remove(),this.element.data("annotator",null),r=this.plugins;for(o in r)i=r[o],this.plugins[o].destroy();return this.removeEvents(),t=n._instances.indexOf(this),-1!==t?n._instances.splice(t,1):void 0},n.prototype.getSelectedRanges=function(){var t,n,o,i,a,u,l,h,d;for(l=s.getGlobal().getSelection(),a=[],u=[],l.isCollapsed||(a=function(){var e,s,a;for(a=[],n=e=0,s=l.rangeCount;s>=0?s>e:e>s;n=s>=0?++e:--e)i=l.getRangeAt(n),t=new r.BrowserRange(i),o=t.normalize().limit(this.wrapper[0]),null===o&&u.push(i),a.push(o);return a}.call(this),l.removeAllRanges()),h=0,d=u.length;d>h;h++)i=u[h],l.addRange(i);return e.grep(a,function(t){return t&&l.addRange(t.toRange()),t})},n.prototype.createAnnotation=function(){var t;return t={},this.publish("beforeAnnotationCreated",[t]),t},n.prototype.setupAnnotation=function(t){var n,o,i,s,a,u,l,h,d,c;for(a=this.wrapper[0],t.ranges||(t.ranges=this.selectedRanges),i=[],c=t.ranges,u=0,h=c.length;h>u;u++){s=c[u];try{i.push(r.sniff(s).normalize(a))}catch(p){if(n=p,!(n instanceof r.RangeError))throw n;this.publish("rangeNormalizeFail",[t,s,n])}}for(t.quote=[],t.ranges=[],t.highlights=[],l=0,d=i.length;d>l;l++)o=i[l],t.quote.push(e.trim(o.text())),t.ranges.push(o.serialize(this.wrapper[0],".annotator-hl")),e.merge(t.highlights,this.highlightRange(o));return t.quote=t.quote.join(" / "),e(t.highlights).data("annotation",t),t},n.prototype.updateAnnotation=function(t){return this.publish("beforeAnnotationUpdated",[t]),this.publish("annotationUpdated",[t]),t},n.prototype.deleteAnnotation=function(t){var n,o,i,r,s;if(null!=t.highlights)for(s=t.highlights,i=0,r=s.length;r>i;i++)o=s[i],null!=o.parentNode&&(n=o.childNodes[0],e(o).replaceWith(o.childNodes));return this.publish("annotationDeleted",[t]),t},n.prototype.loadAnnotations=function(t){var e,n;return null==t&&(t=[]),n=function(t){return function(o){var i,r,s,a;for(null==o&&(o=[]),r=o.splice(0,10),s=0,a=r.length;a>s;s++)i=r[s],t.setupAnnotation(i);return o.length>0?setTimeout(function(){return n(o)},10):t.publish("annotationsLoaded",[e])}}(this),e=t.slice(),n(t),this},n.prototype.dumpAnnotations=function(){return this.plugins.Store?this.plugins.Store.dumpAnnotations():(console.warn(k("Can't dump annotations without Store plugin.")),!1)},n.prototype.highlightRange=function(t,n){var o,i,r,s,a,u,l;for(null==n&&(n="annotator-hl"),r=/^\s*$/,o=e("<span class='"+n+"'></span>"),u=t.textNodes(),l=[],s=0,a=u.length;a>s;s++)i=u[s],r.test(i.nodeValue)||l.push(e(i).wrapAll(o).parent().show()[0]);return l},n.prototype.highlightRanges=function(t,n){var o,i,r,s;for(null==n&&(n="annotator-hl"),o=[],r=0,s=t.length;s>r;r++)i=t[r],e.merge(o,this.highlightRange(i,n));return o},n.prototype.addPlugin=function(t,e){var o,i;return this.plugins[t]?console.error(k("You cannot have more than one instance of any plugin.")):(o=n.Plugin[t],"function"==typeof o?(this.plugins[t]=new o(this.element[0],e),this.plugins[t].annotator=this,"function"==typeof(i=this.plugins[t]).pluginInit&&i.pluginInit()):console.error(k("Could not load ")+t+k(" plugin. Have you included the appropriate <script> tag?"))),this},n.prototype.showEditor=function(t,e){return this.editor.element.css(e),this.editor.load(t),this.publish("annotationEditorShown",[this.editor,t]),this},n.prototype.onEditorHide=function(){return this.publish("annotationEditorHidden",[this.editor]),this.ignoreMouseup=!1},n.prototype.onEditorSubmit=function(t){return this.publish("annotationEditorSubmit",[this.editor,t])},n.prototype.showViewer=function(t,e){return this.viewer.element.css(e),this.viewer.load(t),this.publish("annotationViewerShown",[this.viewer,t])},n.prototype.startViewerHideTimer=function(){return this.viewerHideTimer?void 0:this.viewerHideTimer=setTimeout(this.viewer.hide,250)},n.prototype.clearViewerHideTimer=function(){return clearTimeout(this.viewerHideTimer),this.viewerHideTimer=!1},n.prototype.checkForStartSelection=function(t){return t&&this.isAnnotator(t.target)||this.startViewerHideTimer(),this.mouseIsDown=!0},n.prototype.checkForEndSelection=function(t){var n,o,i,r,a;if(this.mouseIsDown=!1,!this.ignoreMouseup){for(this.selectedRanges=this.getSelectedRanges(),a=this.selectedRanges,i=0,r=a.length;r>i;i++)if(o=a[i],n=o.commonAncestor,e(n).hasClass("annotator-hl")&&(n=e(n).parents("[class!=annotator-hl]")[0]),this.isAnnotator(n))return;return t&&this.selectedRanges.length?this.adder.css(s.mousePosition(t,this.wrapper[0])).show():this.adder.hide()}},n.prototype.isAnnotator=function(t){return!!e(t).parents().addBack().filter("[class^=annotator-]").not(this.wrapper).length},n.prototype.onHighlightMouseover=function(t){var n;return this.clearViewerHideTimer(),this.mouseIsDown||this.viewer.isShown()?!1:(n=e(t.target).parents(".annotator-hl").addBack().map(function(){return e(this).data("annotation")}),this.showViewer(e.makeArray(n),s.mousePosition(t,this.wrapper[0])))},n.prototype.onAdderMousedown=function(t){return null!=t&&t.preventDefault(),this.ignoreMouseup=!0},n.prototype.onAdderClick=function(t){var n,o,i,r,s;return null!=t&&t.preventDefault(),r=this.adder.position(),this.adder.hide(),n=this.setupAnnotation(this.createAnnotation()),e(n.highlights).addClass("annotator-hl-temporary"),s=function(t){return function(){return i(),e(n.highlights).removeClass("annotator-hl-temporary"),t.publish("annotationCreated",[n])}}(this),o=function(t){return function(){return i(),t.deleteAnnotation(n)}}(this),i=function(t){return function(){return t.unsubscribe("annotationEditorHidden",o),t.unsubscribe("annotationEditorSubmit",s)}}(this),this.subscribe("annotationEditorHidden",o),this.subscribe("annotationEditorSubmit",s),this.showEditor(n,r)},n.prototype.onEditAnnotation=function(t){var e,n,o;return n=this.viewer.element.position(),o=function(n){return function(){return e(),n.updateAnnotation(t)}}(this),e=function(t){return function(){return t.unsubscribe("annotationEditorHidden",e),t.unsubscribe("annotationEditorSubmit",o)}}(this),this.subscribe("annotationEditorHidden",e),this.subscribe("annotationEditorSubmit",o),this.viewer.hide(),this.showEditor(t,n)},n.prototype.onDeleteAnnotation=function(t){return this.viewer.hide(),this.deleteAnnotation(t)},n}(o),n.Plugin=function(t){function e(){e.__super__.constructor.apply(this,arguments)}return D(e,t),e.prototype.pluginInit=function(){},e.prototype.destroy=function(){return this.removeEvents()},e}(o),p=s.getGlobal(),null==(null!=(S=p.document)?S.evaluate:void 0)&&e.getScript("http://assets.annotateit.org/vendor/xpath.min.js"),null==p.getSelection&&e.getScript("http://assets.annotateit.org/vendor/ierange.min.js"),null==p.JSON&&e.getScript("http://assets.annotateit.org/vendor/json2.min.js"),null==p.Node&&(p.Node={ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12}),n.$=e,n.Delegator=o,n.Range=r,n.Util=s,n._instances=[],n._t=k,n.supported=function(){return function(){return!!this.getSelection}()},n.noConflict=function(){return s.getGlobal().Annotator=b,this},e.fn.annotator=function(t){var o;return o=Array.prototype.slice.call(arguments,1),this.each(function(){var i;return i=e.data(this,"annotator"),i?t&&i[t].apply(i,o):(i=new n(this,t),e.data(this,"annotator",i))})},this.Annotator=n,n.Widget=function(t){function o(){o.__super__.constructor.apply(this,arguments),this.classes=e.extend({},n.Widget.prototype.classes,this.classes)}return D(o,t),o.prototype.classes={hide:"annotator-hide",invert:{x:"annotator-invert-x",y:"annotator-invert-y"}},o.prototype.destroy=function(){return this.removeEvents(),this.element.remove()},o.prototype.checkOrientation=function(){var t,o,i,r,s;return this.resetOrientation(),s=e(n.Util.getGlobal()),r=this.element.children(":first"),o=r.offset(),i={top:s.scrollTop(),right:s.width()+s.scrollLeft()},t={top:o.top,right:o.left+r.width()},t.top-i.top<0&&this.invertY(),t.right-i.right>0&&this.invertX(),this},o.prototype.resetOrientation=function(){return this.element.removeClass(this.classes.invert.x).removeClass(this.classes.invert.y),this},o.prototype.invertX=function(){return this.element.addClass(this.classes.invert.x),this},o.prototype.invertY=function(){return this.element.addClass(this.classes.invert.y),this},o.prototype.isInvertedY=function(){return this.element.hasClass(this.classes.invert.y)},o.prototype.isInvertedX=function(){return this.element.hasClass(this.classes.invert.x)},o}(o),n.Editor=function(t){function o(t){this.onCancelButtonMouseover=O(this.onCancelButtonMouseover,this),this.processKeypress=O(this.processKeypress,this),this.submit=O(this.submit,this),this.load=O(this.load,this),this.hide=O(this.hide,this),this.show=O(this.show,this),o.__super__.constructor.call(this,e(this.html)[0],t),this.fields=[],this.annotation={}}return D(o,t),o.prototype.events={"form submit":"submit",".annotator-save click":"submit",".annotator-cancel click":"hide",".annotator-cancel mouseover":"onCancelButtonMouseover","textarea keydown":"processKeypress"},o.prototype.classes={hide:"annotator-hide",focus:"annotator-focus"},o.prototype.html='<div class="annotator-outer annotator-editor">\n  <form class="annotator-widget">\n    <ul class="annotator-listing"></ul>\n    <div class="annotator-controls">\n      <a href="#cancel" class="annotator-cancel">'+k("Cancel")+'</a>\n<a href="#save" class="annotator-save annotator-focus">'+k("Save")+"</a>\n    </div>\n  </form>\n</div>",o.prototype.options={},o.prototype.show=function(t){return n.Util.preventEventDefault(t),this.element.removeClass(this.classes.hide),this.element.find(".annotator-save").addClass(this.classes.focus),this.checkOrientation(),this.element.find(":input:first").focus(),this.setupDraggables(),this.publish("show")},o.prototype.hide=function(t){return n.Util.preventEventDefault(t),this.element.addClass(this.classes.hide),this.publish("hide")},o.prototype.load=function(t){var e,n,o,i;for(this.annotation=t,this.publish("load",[this.annotation]),i=this.fields,n=0,o=i.length;o>n;n++)e=i[n],e.load(e.element,this.annotation);return this.show()},o.prototype.submit=function(t){var e,o,i,r;for(n.Util.preventEventDefault(t),r=this.fields,o=0,i=r.length;i>o;o++)e=r[o],e.submit(e.element,this.annotation);return this.publish("save",[this.annotation]),this.hide()},o.prototype.addField=function(t){var o,i,r;switch(i=e.extend({id:"annotator-field-"+n.Util.uuid(),type:"input",label:"",load:function(){},submit:function(){}},t),r=null,o=e('<li class="annotator-item" />'),i.element=o[0],i.type){case"textarea":r=e("<textarea />");break;case"input":case"checkbox":r=e("<input />");break;case"select":r=e("<select />")}return o.append(r),r.attr({id:i.id,placeholder:i.label}),"checkbox"===i.type&&(r[0].type="checkbox",o.addClass("annotator-checkbox"),o.append(e("<label />",{"for":i.id,html:i.label}))),this.element.find("ul:first").append(o),this.fields.push(i),i.element},o.prototype.checkOrientation=function(){var t,e;return o.__super__.checkOrientation.apply(this,arguments),e=this.element.find("ul"),t=this.element.find(".annotator-controls"),this.element.hasClass(this.classes.invert.y)?t.insertBefore(e):t.is(":first-child")&&t.insertAfter(e),this},o.prototype.processKeypress=function(t){return 27===t.keyCode?this.hide():13!==t.keyCode||t.shiftKey?void 0:this.submit()},o.prototype.onCancelButtonMouseover=function(){return this.element.find("."+this.classes.focus).removeClass(this.classes.focus)},o.prototype.setupDraggables=function(){var t,n,o,i,r,s,a,u,l,h,d;return this.element.find(".annotator-resize").remove(),o=this.element.find(this.element.hasClass(this.classes.invert.y)?".annotator-item:last":".annotator-item:first"),o&&e('<span class="annotator-resize"></span>').appendTo(o),r=null,t=this.classes,i=this.element,h=null,l=i.find(".annotator-resize"),n=i.find(".annotator-controls"),d=!1,s=function(t){return t.target===this?(r={element:this,top:t.pageY,left:t.pageX},h=i.find("textarea:first"),e(window).bind({"mouseup.annotator-editor-resize":u,"mousemove.annotator-editor-resize":a}),t.preventDefault()):void 0},u=function(){return r=null,e(window).unbind(".annotator-editor-resize")},a=function(){return function(e){var o,s,a,u,c;return r&&d===!1?(o={top:e.pageY-r.top,left:e.pageX-r.left},r.element===l[0]?(u=h.outerHeight(),c=h.outerWidth(),s=i.hasClass(t.invert.x)?-1:1,a=i.hasClass(t.invert.y)?1:-1,h.height(u+o.top*a),h.width(c+o.left*s),h.outerHeight()!==u&&(r.top=e.pageY),h.outerWidth()!==c&&(r.left=e.pageX)):r.element===n[0]&&(i.css({top:parseInt(i.css("top"),10)+o.top,left:parseInt(i.css("left"),10)+o.left}),r.top=e.pageY,r.left=e.pageX),d=!0,setTimeout(function(){return d=!1},1e3/60)):void 0}}(this),l.bind("mousedown",s),n.bind("mousedown",s)},o}(n.Widget),n.Viewer=function(t){function o(t){this.onDeleteClick=O(this.onDeleteClick,this),this.onEditClick=O(this.onEditClick,this),this.load=O(this.load,this),this.hide=O(this.hide,this),this.show=O(this.show,this),o.__super__.constructor.call(this,e(this.html.element)[0],t),this.item=e(this.html.item)[0],this.fields=[],this.annotations=[]}return D(o,t),o.prototype.events={".annotator-edit click":"onEditClick",".annotator-delete click":"onDeleteClick"},o.prototype.classes={hide:"annotator-hide",showControls:"annotator-visible"},o.prototype.html={element:'<div class="annotator-outer annotator-viewer">\n  <ul class="annotator-widget annotator-listing"></ul>\n</div>',item:'<li class="annotator-annotation annotator-item">\n  <span class="annotator-controls">\n    <a href="#" title="View as webpage" class="annotator-link">View as webpage</a>\n    <button title="Edit" class="annotator-edit">Edit</button>\n    <button title="Delete" class="annotator-delete">Delete</button>\n  </span>\n</li>'},o.prototype.options={readOnly:!1},o.prototype.show=function(t){var e;return n.Util.preventEventDefault(t),e=this.element.find(".annotator-controls").addClass(this.classes.showControls),setTimeout(function(t){return function(){return e.removeClass(t.classes.showControls)}}(this),500),this.element.removeClass(this.classes.hide),this.checkOrientation().publish("show")},o.prototype.isShown=function(){return!this.element.hasClass(this.classes.hide)},o.prototype.hide=function(t){return n.Util.preventEventDefault(t),this.element.addClass(this.classes.hide),this.publish("hide")},o.prototype.load=function(t){var n,o,r,s,a,u,l,h,d,c,p,f,g,m,y,v,w;for(this.annotations=t||[],p=this.element.find("ul:first").empty(),v=this.annotations,f=0,m=v.length;m>f;f++)for(n=v[f],h=e(this.item).clone().appendTo(p).data("annotation",n),r=h.find(".annotator-controls"),d=r.find(".annotator-link"),a=r.find(".annotator-edit"),s=r.find(".annotator-delete"),c=new i(n.links||[]).get("alternate",{type:"text/html"}),0===c.length||null==c[0].href?d.remove():d.attr("href",c[0].href),this.options.readOnly?(a.remove(),s.remove()):o={showEdit:function(){return a.removeAttr("disabled")},hideEdit:function(){return a.attr("disabled","disabled")},showDelete:function(){return s.removeAttr("disabled")},hideDelete:function(){return s.attr("disabled","disabled")}},w=this.fields,g=0,y=w.length;y>g;g++)l=w[g],u=e(l.element).clone().appendTo(h)[0],l.load(u,n,o);
return this.publish("load",[this.annotations]),this.show()},o.prototype.addField=function(t){var n;return n=e.extend({load:function(){}},t),n.element=e("<div />")[0],this.fields.push(n),n.element,this},o.prototype.onEditClick=function(t){return this.onButtonClick(t,"edit")},o.prototype.onDeleteClick=function(t){return this.onButtonClick(t,"delete")},o.prototype.onButtonClick=function(t,n){var o;return o=e(t.target).parents(".annotator-annotation"),this.publish(n,[o.data("annotation")])},o}(n.Widget),i=function(){function t(t){this.data=t}return t.prototype.get=function(t,n){var o,i,r,s,a,u,l,h,d;for(null==n&&(n={}),n=e.extend({},n,{rel:t}),r=function(){var t;t=[];for(i in n)F.call(n,i)&&(a=n[i],t.push(i));return t}(),h=this.data,d=[],u=0,l=h.length;l>u;u++)o=h[u],s=r.reduce(function(t,e){return t&&o[e]===n[e]},!0),s&&d.push(o);return d},t}(),n=n||{},n.Notification=function(t){function o(t){this.hide=O(this.hide,this),this.show=O(this.show,this),o.__super__.constructor.call(this,e(this.options.html).appendTo(document.body)[0],t)}return D(o,t),o.prototype.events={click:"hide"},o.prototype.options={html:"<div class='annotator-notice'></div>",classes:{show:"annotator-notice-show",info:"annotator-notice-info",success:"annotator-notice-success",error:"annotator-notice-error"}},o.prototype.show=function(t,o){return null==o&&(o=n.Notification.INFO),this.currentStatus=o,e(this.element).addClass(this.options.classes.show).addClass(this.options.classes[this.currentStatus]).html(s.escape(t||"")),setTimeout(this.hide,5e3),this},o.prototype.hide=function(){return null==this.currentStatus&&(this.currentStatus=n.Notification.INFO),e(this.element).removeClass(this.options.classes.show).removeClass(this.options.classes[this.currentStatus]),this},o}(o),n.Notification.INFO="info",n.Notification.SUCCESS="success",n.Notification.ERROR="error",e(function(){var t;return t=new n.Notification,n.showNotification=t.show,n.hideNotification=t.hide}),n.Plugin.Unsupported=function(t){function o(){return o.__super__.constructor.apply(this,arguments)}return D(o,t),o.prototype.options={message:n._t("Sorry your current browser does not support the Annotator")},o.prototype.pluginInit=function(){return n.supported()?void 0:e(function(t){return function(){return n.showNotification(t.options.message),void 0===window.XMLHttpRequest&&void 0!==ActiveXObject?e("html").addClass("ie6"):void 0}}(this))},o}(n.Plugin),l=function(t){var e,n,o,i,r,s;return i="([0-9]{4})(-([0-9]{2})(-([0-9]{2})(T([0-9]{2}):([0-9]{2})(:([0-9]{2})(\\.([0-9]+))?)?(Z|(([-+])([0-9]{2}):([0-9]{2})))?)?)?)?",e=t.match(new RegExp(i)),o=0,n=new Date(e[1],0,1),e[3]&&n.setMonth(e[3]-1),e[5]&&n.setDate(e[5]),e[7]&&n.setHours(e[7]),e[8]&&n.setMinutes(e[8]),e[10]&&n.setSeconds(e[10]),e[12]&&n.setMilliseconds(1e3*Number("0."+e[12])),e[14]&&(o=60*Number(e[16])+Number(e[17]),o*=null!=(s="-"===e[15])?s:{1:-1}),o-=n.getTimezoneOffset(),r=Number(n)+60*o*1e3,n.setTime(Number(r)),n},a=function(t){var e,n,o,i,r,s,a,u,l,h,d,c,p;if("undefined"!=typeof atob&&null!==atob)return atob(t);if(n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",l=0,e=0,i="",p=[],!t)return t;for(t+="";l<t.length;)r=n.indexOf(t.charAt(l++)),s=n.indexOf(t.charAt(l++)),a=n.indexOf(t.charAt(l++)),u=n.indexOf(t.charAt(l++)),o=r<<18|s<<12|a<<6|u,h=o>>16&255,d=o>>8&255,c=255&o,p[e++]=64===a?String.fromCharCode(h):64===u?String.fromCharCode(h,d):String.fromCharCode(h,d,c);return p.join("")},u=function(t){var e,n,o,i;if(n=t.length%4,0!==n)for(e=o=0,i=4-n;i>=0?i>o:o>i;e=i>=0?++o:--o)t+="=";return t=t.replace(/-/g,"+"),t=t.replace(/_/g,"/"),a(t)},y=function(t){var e,n,o,i;return i=t.split("."),e=i[0],n=i[1],o=i[2],JSON.parse(u(n))},n.Plugin.Auth=function(t){function o(){o.__super__.constructor.apply(this,arguments),this.waitingForToken=[],this.options.token?this.setToken(this.options.token):this.requestToken()}return D(o,t),o.prototype.options={token:null,tokenUrl:"/auth/token",autoFetch:!0},o.prototype.requestToken=function(){return this.requestInProgress=!0,e.ajax({url:this.options.tokenUrl,dataType:"text",xhrFields:{withCredentials:!0}}).done(function(t){return function(e){return t.setToken(e)}}(this)).fail(function(){return function(t,e,o){var i;return i=n._t("Couldn't get auth token:"),console.error(""+i+" "+o,t),n.showNotification(""+i+" "+t.responseText,n.Notification.ERROR)}}(this)).always(function(t){return function(){return t.requestInProgress=!1}}(this))},o.prototype.setToken=function(t){var e;if(this.token=t,this._unsafeToken=y(t),this.haveValidToken()){for(this.options.autoFetch&&(this.refreshTimeout=setTimeout(function(t){return function(){return t.requestToken()}}(this),1e3*(this.timeToExpiry()-2))),this.updateHeaders(),e=[];this.waitingForToken.length>0;)e.push(this.waitingForToken.pop()(this._unsafeToken));return e}return console.warn(n._t("Didn't get a valid token.")),this.options.autoFetch?(console.warn(n._t("Getting a new token in 10s.")),setTimeout(function(t){return function(){return t.requestToken()}}(this),1e4)):void 0},o.prototype.haveValidToken=function(){var t;return t=this._unsafeToken&&this._unsafeToken.issuedAt&&this._unsafeToken.ttl&&this._unsafeToken.consumerKey,t&&this.timeToExpiry()>0?!0:!1},o.prototype.timeToExpiry=function(){var t,e,n,o;return n=(new Date).getTime()/1e3,e=l(this._unsafeToken.issuedAt).getTime()/1e3,t=e+this._unsafeToken.ttl,o=t-n,o>0?o:0},o.prototype.updateHeaders=function(){var t;return t=this.element.data("annotator:headers"),this.element.data("annotator:headers",e.extend(t,{"x-annotator-auth-token":this.token}))},o.prototype.withToken=function(t){return null!=t?this.haveValidToken()?t(this._unsafeToken):(this.waitingForToken.push(t),this.requestInProgress?void 0:this.requestToken()):void 0},o}(n.Plugin),n.Plugin.Store=function(t){function o(){this._onError=O(this._onError,this),this._onLoadAnnotationsFromSearch=O(this._onLoadAnnotationsFromSearch,this),this._onLoadAnnotations=O(this._onLoadAnnotations,this),this._getAnnotations=O(this._getAnnotations,this),o.__super__.constructor.apply(this,arguments),this.annotations=[]}return D(o,t),o.prototype.events={annotationCreated:"annotationCreated",annotationDeleted:"annotationDeleted",annotationUpdated:"annotationUpdated"},o.prototype.options={annotationData:{},emulateHTTP:!1,loadFromSearch:!1,prefix:"/store",urls:{create:"/annotations",read:"/annotations/:id",update:"/annotations/:id",destroy:"/annotations/:id",search:"/search"}},o.prototype.pluginInit=function(){return n.supported()?this.annotator.plugins.Auth?this.annotator.plugins.Auth.withToken(this._getAnnotations):this._getAnnotations():void 0},o.prototype._getAnnotations=function(){return this.options.loadFromSearch?this.loadAnnotationsFromSearch(this.options.loadFromSearch):this.loadAnnotations()},o.prototype.annotationCreated=function(t){return P.call(this.annotations,t)<0?(this.registerAnnotation(t),this._apiRequest("create",t,function(e){return function(o){return null==o.id&&console.warn(n._t("Warning: No ID returned from server for annotation "),t),e.updateAnnotation(t,o)}}(this))):this.updateAnnotation(t,{})},o.prototype.annotationUpdated=function(t){return P.call(this.annotations,t)>=0?this._apiRequest("update",t,function(e){return function(n){return e.updateAnnotation(t,n)}}(this)):void 0},o.prototype.annotationDeleted=function(t){return P.call(this.annotations,t)>=0?this._apiRequest("destroy",t,function(e){return function(){return e.unregisterAnnotation(t)}}(this)):void 0},o.prototype.registerAnnotation=function(t){return this.annotations.push(t)},o.prototype.unregisterAnnotation=function(t){return this.annotations.splice(this.annotations.indexOf(t),1)},o.prototype.updateAnnotation=function(t,o){return P.call(this.annotations,t)<0?console.error(n._t("Trying to update unregistered annotation!")):e.extend(t,o),e(t.highlights).data("annotation",t)},o.prototype.loadAnnotations=function(){return this._apiRequest("read",null,this._onLoadAnnotations)},o.prototype._onLoadAnnotations=function(t){var e,n,o,i,r,s,a,u,l;for(null==t&&(t=[]),o={},l=this.annotations,r=0,a=l.length;a>r;r++)e=l[r],o[e.id]=e;for(i=[],s=0,u=t.length;u>s;s++)e=t[s],o[e.id]?(n=o[e.id],this.updateAnnotation(n,e)):i.push(e);return this.annotations=this.annotations.concat(i),this.annotator.loadAnnotations(i.slice())},o.prototype.loadAnnotationsFromSearch=function(t){return this._apiRequest("search",t,this._onLoadAnnotationsFromSearch)},o.prototype._onLoadAnnotationsFromSearch=function(t){return null==t&&(t={}),this._onLoadAnnotations(t.rows||[])},o.prototype.dumpAnnotations=function(){var t,e,n,o,i;for(o=this.annotations,i=[],e=0,n=o.length;n>e;e++)t=o[e],i.push(JSON.parse(this._dataFor(t)));return i},o.prototype._apiRequest=function(t,n,o){var i,r,s,a;return i=n&&n.id,a=this._urlFor(t,i),r=this._apiRequestOptions(t,n,o),s=e.ajax(a,r),s._id=i,s._action=t,s},o.prototype._apiRequestOptions=function(t,n,o){var i,r,s;return r=this._methodFor(t),s={type:r,headers:this.element.data("annotator:headers"),dataType:"json",success:o||function(){},error:this._onError},!this.options.emulateHTTP||"PUT"!==r&&"DELETE"!==r||(s.headers=e.extend(s.headers,{"X-HTTP-Method-Override":r}),s.type="POST"),"search"===t?s=e.extend(s,{data:n}):(i=n&&this._dataFor(n),this.options.emulateJSON?(s.data={json:i},this.options.emulateHTTP&&(s.data._method=r),s):s=e.extend(s,{data:i,contentType:"application/json; charset=utf-8"}))},o.prototype._urlFor=function(t,e){var n;return n=null!=this.options.prefix?this.options.prefix:"",n+=this.options.urls[t],n=n.replace(/\/:id/,null!=e?"/"+e:""),n=n.replace(/:id/,null!=e?e:"")},o.prototype._methodFor=function(t){var e;return e={create:"POST",read:"GET",update:"PUT",destroy:"DELETE",search:"GET"},e[t]},o.prototype._dataFor=function(t){var n,o;return o=t.highlights,delete t.highlights,e.extend(t,this.options.annotationData),n=JSON.stringify(t),o&&(t.highlights=o),n},o.prototype._onError=function(t){var e,o;switch(e=t._action,o=n._t("Sorry we could not ")+e+n._t(" this annotation"),"search"===t._action?o=n._t("Sorry we could not search the store for annotations"):"read"!==t._action||t._id||(o=n._t("Sorry we could not ")+e+n._t(" the annotations from the store")),t.status){case 401:o=n._t("Sorry you are not allowed to ")+e+n._t(" this annotation");break;case 404:o=n._t("Sorry we could not connect to the annotations store");break;case 500:o=n._t("Sorry something went wrong with the annotation store")}return n.showNotification(o,n.Notification.ERROR),console.error(n._t("API request failed:")+(" '"+t.status+"'"))},o}(n.Plugin),n.Plugin.Permissions=function(t){function o(){this._setAuthFromToken=O(this._setAuthFromToken,this),this.updateViewer=O(this.updateViewer,this),this.updateAnnotationPermissions=O(this.updateAnnotationPermissions,this),this.updatePermissionsField=O(this.updatePermissionsField,this),this.addFieldsToAnnotation=O(this.addFieldsToAnnotation,this),o.__super__.constructor.apply(this,arguments),this.options.user&&(this.setUser(this.options.user),delete this.options.user)}return D(o,t),o.prototype.events={beforeAnnotationCreated:"addFieldsToAnnotation"},o.prototype.options={showViewPermissionsCheckbox:!0,showEditPermissionsCheckbox:!0,userId:function(t){return t},userString:function(t){return t},userAuthorize:function(t,e,n){var o,i,r,s;if(e.permissions){if(i=e.permissions[t]||[],0===i.length)return!0;for(r=0,s=i.length;s>r;r++)if(o=i[r],this.userId(n)===o)return!0;return!1}return e.user?n?this.userId(n)===this.userId(e.user):!1:!0},user:"",permissions:{read:[],update:[],"delete":[],admin:[]}},o.prototype.pluginInit=function(){var t,e;if(n.supported())return e=this,t=function(t,n){return function(o,i){return e[t].call(e,n,o,i)}},!this.user&&this.annotator.plugins.Auth&&this.annotator.plugins.Auth.withToken(this._setAuthFromToken),this.options.showViewPermissionsCheckbox===!0&&this.annotator.editor.addField({type:"checkbox",label:n._t("Allow anyone to <strong>view</strong> this annotation"),load:t("updatePermissionsField","read"),submit:t("updateAnnotationPermissions","read")}),this.options.showEditPermissionsCheckbox===!0&&this.annotator.editor.addField({type:"checkbox",label:n._t("Allow anyone to <strong>edit</strong> this annotation"),load:t("updatePermissionsField","update"),submit:t("updateAnnotationPermissions","update")}),this.annotator.viewer.addField({load:this.updateViewer}),this.annotator.plugins.Filter?this.annotator.plugins.Filter.addFilter({label:n._t("User"),property:"user",isFiltered:function(t){return function(e,n){var o,i,r,s;if(n=t.options.userString(n),!e||!n)return!1;for(s=e.split(/\s*/),i=0,r=s.length;r>i;i++)if(o=s[i],-1===n.indexOf(o))return!1;return!0}}(this)}):void 0},o.prototype.setUser=function(t){return this.user=t},o.prototype.addFieldsToAnnotation=function(t){return t&&(t.permissions=this.options.permissions,this.user)?t.user=this.user:void 0},o.prototype.authorize=function(t,e,n){return void 0===n&&(n=this.user),this.options.userAuthorize?this.options.userAuthorize.call(this.options,t,e,n):!0},o.prototype.updatePermissionsField=function(t,n,o){var i;return n=e(n).show(),i=n.find("input").removeAttr("disabled"),this.authorize("admin",o)||n.hide(),this.authorize(t,o||{},null)?i.attr("checked","checked"):i.removeAttr("checked")},o.prototype.updateAnnotationPermissions=function(t,n,o){var i;return o.permissions||(o.permissions=this.options.permissions),i=t+"-permissions",o.permissions[t]=e(n).find("input").is(":checked")?[]:[this.options.userId(this.user)]},o.prototype.updateViewer=function(t,o,i){var r,s;return t=e(t),s=this.options.userString(o.user),o.user&&s&&"string"==typeof s?(r=n.Util.escape(this.options.userString(o.user)),t.html(r).addClass("annotator-user")):t.remove(),i&&(this.authorize("update",o)||i.hideEdit(),!this.authorize("delete",o))?i.hideDelete():void 0},o.prototype._setAuthFromToken=function(t){return this.setUser(t.userId)},o}(n.Plugin),n.Plugin.AnnotateItPermissions=function(t){function n(){return this._setAuthFromToken=O(this._setAuthFromToken,this),this.updateAnnotationPermissions=O(this.updateAnnotationPermissions,this),this.updatePermissionsField=O(this.updatePermissionsField,this),this.addFieldsToAnnotation=O(this.addFieldsToAnnotation,this),n.__super__.constructor.apply(this,arguments)}return D(n,t),n.prototype.options={showViewPermissionsCheckbox:!0,showEditPermissionsCheckbox:!0,groups:{world:"group:__world__",authenticated:"group:__authenticated__",consumer:"group:__consumer__"},userId:function(t){return t.userId},userString:function(t){return t.userId},userAuthorize:function(t,e,n){var o,i,r,s,a,u;return i=e.permissions||{},o=i[t]||[],r=this.groups.world,P.call(o,r)>=0?!0:null!=n&&null!=n.userId&&null!=n.consumerKey?n.userId===e.user&&n.consumerKey===e.consumer?!0:(s=this.groups.authenticated,P.call(o,s)>=0?!0:n.consumerKey===e.consumer&&(a=this.groups.consumer,P.call(o,a)>=0)?!0:n.consumerKey===e.consumer&&(u=n.userId,P.call(o,u)>=0)?!0:n.consumerKey===e.consumer&&n.admin?!0:!1):!1},permissions:{read:["group:__world__"],update:[],"delete":[],admin:[]}},n.prototype.addFieldsToAnnotation=function(t){return t&&(t.permissions=this.options.permissions,this.user)?(t.user=this.user.userId,t.consumer=this.user.consumerKey):void 0},n.prototype.updatePermissionsField=function(t,n,o){var i;return n=e(n).show(),i=n.find("input").removeAttr("disabled"),this.authorize("admin",o)||n.hide(),this.user&&this.authorize(t,o||{},{userId:"__nonexistentuser__",consumerKey:this.user.consumerKey})?i.attr("checked","checked"):i.removeAttr("checked")},n.prototype.updateAnnotationPermissions=function(t,n,o){var i;return o.permissions||(o.permissions=this.options.permissions),i=t+"-permissions",o.permissions[t]=e(n).find("input").is(":checked")?["read"===t?this.options.groups.world:this.options.groups.consumer]:[]},n.prototype._setAuthFromToken=function(t){return this.setUser(t)},n}(n.Plugin.Permissions),n.Plugin.Filter=function(t){function o(t,n){this._onPreviousClick=O(this._onPreviousClick,this),this._onNextClick=O(this._onNextClick,this),this._onFilterKeyup=O(this._onFilterKeyup,this),this._onFilterBlur=O(this._onFilterBlur,this),this._onFilterFocus=O(this._onFilterFocus,this),this.updateHighlights=O(this.updateHighlights,this);var i;t=e(this.html.element).appendTo((null!=n?n.appendTo:void 0)||this.options.appendTo),o.__super__.constructor.call(this,t,n),(i=this.options).filters||(i.filters=[]),this.filter=e(this.html.filter),this.filters=[],this.current=0}return D(o,t),o.prototype.events={".annotator-filter-property input focus":"_onFilterFocus",".annotator-filter-property input blur":"_onFilterBlur",".annotator-filter-property input keyup":"_onFilterKeyup",".annotator-filter-previous click":"_onPreviousClick",".annotator-filter-next click":"_onNextClick",".annotator-filter-clear click":"_onClearClick"},o.prototype.classes={active:"annotator-filter-active",hl:{hide:"annotator-hl-filtered",active:"annotator-hl-active"}},o.prototype.html={element:'<div class="annotator-filter">\n  <strong>'+n._t("Navigate:")+'</strong>\n<span class="annotator-filter-navigation">\n  <button class="annotator-filter-previous">'+n._t("Previous")+'</button>\n<button class="annotator-filter-next">'+n._t("Next")+"</button>\n</span>\n<strong>"+n._t("Filter by:")+"</strong>\n</div>",filter:'<span class="annotator-filter-property">\n  <label></label>\n  <input/>\n  <button class="annotator-filter-clear">'+n._t("Clear")+"</button>\n</span>"},o.prototype.options={appendTo:"body",filters:[],addAnnotationFilter:!0,isFiltered:function(t,e){var n,o,i,r;if(!t||!e)return!1;for(r=t.split(/\s+/),o=0,i=r.length;i>o;o++)if(n=r[o],-1===e.indexOf(n))return!1;return!0}},o.prototype.pluginInit=function(){var t,e,o,i;for(i=this.options.filters,e=0,o=i.length;o>e;e++)t=i[e],this.addFilter(t);return this.updateHighlights(),this._setupListeners()._insertSpacer(),this.options.addAnnotationFilter===!0?this.addFilter({label:n._t("Annotation"),property:"text"}):void 0},o.prototype.destroy=function(){var t,n;return o.__super__.destroy.apply(this,arguments),n=e("html"),t=parseInt(n.css("padding-top"),10)||0,n.css("padding-top",t-this.element.outerHeight()),this.element.remove()},o.prototype._insertSpacer=function(){var t,n;return n=e("html"),t=parseInt(n.css("padding-top"),10)||0,n.css("padding-top",t+this.element.outerHeight()),this},o.prototype._setupListeners=function(){var t,e,n,o;for(e=["annotationsLoaded","annotationCreated","annotationUpdated","annotationDeleted"],n=0,o=e.length;o>n;n++)t=e[n],this.annotator.subscribe(t,this.updateHighlights);return this},o.prototype.addFilter=function(t){var o,i;return i=e.extend({label:"",property:"",isFiltered:this.options.isFiltered},t),function(){var t,e,n,r;for(n=this.filters,r=[],t=0,e=n.length;e>t;t++)o=n[t],o.property===i.property&&r.push(o);return r}.call(this).length||(i.id="annotator-filter-"+i.property,i.annotations=[],i.element=this.filter.clone().appendTo(this.element),i.element.find("label").html(i.label).attr("for",i.id),i.element.find("input").attr({id:i.id,placeholder:n._t("Filter by ")+i.label+"â€¦"}),i.element.find("button").hide(),i.element.data("filter",i),this.filters.push(i)),this},o.prototype.updateFilter=function(t){var n,o,i,r,s,a,u;if(t.annotations=[],this.updateHighlights(),this.resetHighlights(),i=e.trim(t.element.find("input").val())){for(o=this.highlights.map(function(){return e(this).data("annotation")}),u=e.makeArray(o),s=0,a=u.length;a>s;s++)n=u[s],r=n[t.property],t.isFiltered(i,r)&&t.annotations.push(n);return this.filterHighlights()}},o.prototype.updateHighlights=function(){return this.highlights=this.annotator.element.find(".annotator-hl:visible"),this.filtered=this.highlights.not(this.classes.hl.hide)},o.prototype.filterHighlights=function(){var t,n,o,i,r,s,a,u,l,h;for(t=e.grep(this.filters,function(t){return!!t.annotations.length}),i=(null!=(h=t[0])?h.annotations:void 0)||[],t.length>1&&(o=[],e.each(t,function(){return e.merge(o,this.annotations)}),a=[],i=[],e.each(o,function(){return-1===e.inArray(this,a)?a.push(this):i.push(this)})),r=this.highlights,s=u=0,l=i.length;l>u;s=++u)n=i[s],r=r.not(n.highlights);return r.addClass(this.classes.hl.hide),this.filtered=this.highlights.not(this.classes.hl.hide),this},o.prototype.resetHighlights=function(){return this.highlights.removeClass(this.classes.hl.hide),this.filtered=this.highlights,this},o.prototype._onFilterFocus=function(t){var n;return n=e(t.target),n.parent().addClass(this.classes.active),n.next("button").show()},o.prototype._onFilterBlur=function(t){var n;return t.target.value?void 0:(n=e(t.target),n.parent().removeClass(this.classes.active),n.next("button").hide())},o.prototype._onFilterKeyup=function(t){var n;return n=e(t.target).parent().data("filter"),n?this.updateFilter(n):void 0},o.prototype._findNextHighlight=function(t){var e,n,o,i,r,s,a,u;return this.highlights.length?(s=t?0:-1,u=t?-1:0,a=t?"lt":"gt",e=this.highlights.not("."+this.classes.hl.hide),o=e.filter("."+this.classes.hl.active),o.length||(o=e.eq(s)),n=o.data("annotation"),i=e.index(o[0]),r=e.filter(":"+a+"("+i+")").not(n.highlights).eq(u),r.length||(r=e.eq(u)),this._scrollToHighlight(r.data("annotation").highlights)):this},o.prototype._onNextClick=function(){return this._findNextHighlight()},o.prototype._onPreviousClick=function(){return this._findNextHighlight(!0)},o.prototype._scrollToHighlight=function(t){return t=e(t),this.highlights.removeClass(this.classes.hl.active),t.addClass(this.classes.hl.active),e("html, body").animate({scrollTop:t.offset().top-(this.element.height()+20)},150)},o.prototype._onClearClick=function(t){return e(t.target).prev("input").val("").keyup().blur()},o}(n.Plugin),n.Plugin.Markdown=function(t){function o(){this.updateTextField=O(this.updateTextField,this),null!=("undefined"!=typeof Showdown&&null!==Showdown?Showdown.converter:void 0)?(o.__super__.constructor.apply(this,arguments),this.converter=new Showdown.converter):console.error(n._t("To use the Markdown plugin, you must include Showdown into the page first."))}return D(o,t),o.prototype.events={annotationViewerTextField:"updateTextField"},o.prototype.updateTextField=function(t,o){var i;return i=n.Util.escape(o.text||""),e(t).html(this.convert(i))},o.prototype.convert=function(t){return this.converter.makeHtml(t)},o}(n.Plugin),n.Plugin.Tags=function(t){function o(){return this.setAnnotationTags=O(this.setAnnotationTags,this),this.updateField=O(this.updateField,this),o.__super__.constructor.apply(this,arguments)}return D(o,t),o.prototype.options={parseTags:function(t){var n;return t=e.trim(t),n=[],t&&(n=t.split(/\s+/)),n},stringifyTags:function(t){return t.join(" ")}},o.prototype.field=null,o.prototype.input=null,o.prototype.pluginInit=function(){return n.supported()?(this.field=this.annotator.editor.addField({label:n._t("Add some tags here")+"â€¦",load:this.updateField,submit:this.setAnnotationTags}),this.annotator.viewer.addField({load:this.updateViewer}),this.annotator.plugins.Filter&&this.annotator.plugins.Filter.addFilter({label:n._t("Tag"),property:"tags",isFiltered:n.Plugin.Tags.filterCallback}),this.input=e(this.field).find(":input")):void 0},o.prototype.parseTags=function(t){return this.options.parseTags(t)},o.prototype.stringifyTags=function(t){return this.options.stringifyTags(t)},o.prototype.updateField=function(t,e){var n;return n="",e.tags&&(n=this.stringifyTags(e.tags)),this.input.val(n)},o.prototype.setAnnotationTags=function(t,e){return e.tags=this.parseTags(this.input.val())},o.prototype.updateViewer=function(t,o){return t=e(t),o.tags&&e.isArray(o.tags)&&o.tags.length?t.addClass("annotator-tags").html(function(){var t;return t=e.map(o.tags,function(t){return'<span class="annotator-tag">'+n.Util.escape(t)+"</span>"}).join(" ")}):t.remove()},o}(n.Plugin),n.Plugin.Tags.filterCallback=function(t,e){var n,o,i,r,s,a,u,l;if(null==e&&(e=[]),i=0,o=[],t)for(o=t.split(/\s+/g),s=0,u=o.length;u>s;s++)if(n=o[s],e.length)for(a=0,l=e.length;l>a;a++)r=e[a],-1!==r.indexOf(n)&&(i+=1);return i===o.length},n.prototype.setupPlugins=function(t,o){var i,r,s,a,u,l,h,d,c;null==t&&(t={}),null==o&&(o={}),l=n.Util.getGlobal(),a=["Unsupported","Auth","Tags","Filter","Store","AnnotateItPermissions"],l.Showdown&&a.push("Markdown"),u=l.location.href.split(/#|\?/).shift()||"",s={Tags:{},Filter:{filters:[{label:n._t("User"),property:"user"},{label:n._t("Tags"),property:"tags"}]},Auth:{tokenUrl:t.tokenUrl||"http://annotateit.org/api/token"},Store:{prefix:t.storeUrl||"http://annotateit.org/api",annotationData:{uri:u},loadFromSearch:{uri:u}}};for(i in o)F.call(o,i)&&(r=o[i],P.call(a,i)<0&&a.push(i));for(e.extend(!0,s,o),c=[],h=0,d=a.length;d>h;h++)i=a[h],c.push(i in s&&!s[i]?void 0:this.addPlugin(i,s[i]));return c}}.call(this),this.Annotator}).call(this),RequireJS.define("annotator_1.2.9",["jquery"],function(t){return function(){var e;return e||t.Annotator}}(this)),function(){RequireJS.define("js/edxnotes/utils/logger",["underscore","logger"],function(t,e){var n,o,i,r=[];return o=function(){return performance&&performance.now?performance.now():Date.now?Date.now():(new Date).getTime()},i=function(t){for(var e,n=r.length;n--;)if(r[n].id===t.id){e=r.splice(n,1)[0],e.historyStorage=[],e.timeStorage={};break}},n=function(t,e){this.id=t,this.historyStorage=[],this.timeStorage={},this.logLevel=e},n.prototype._log=function(t,e){return this.logLevel?(this.updateHistory.apply(this,arguments),Array.prototype.unshift.call(e,this.id),void(console&&console[t]&&(console[t].apply?console[t].apply(console,e):console[t](e.join(" "))))):!1},n.prototype.log=function(){this._log("log",arguments)},n.prototype.error=function(){this._log("error",arguments)},n.prototype.updateHistory=function(){this.historyStorage.push(arguments)},n.prototype.getHistory=function(){return this.historyStorage},n.prototype.time=function(t){this.timeStorage[t]=o()},n.prototype.timeEnd=function(t){return this.timeStorage[t]?(this._log("log",[t,o()-this.timeStorage[t],"ms"]),void delete this.timeStorage[t]):null},n.prototype.destroy=function(){i(this)},n.prototype.emit=function(t,n,o){var i=[t,n];return this.log(t,n),o&&i.push(null,{timeout:o}),e.log.apply(e,i)},{getLogger:function(t,e){var o=new n(t,e);return r.push(o),o},destroyLogger:i}})}.call(this,define||RequireJS.define),function(){RequireJS.define("js/edxnotes/utils/notes_collector",["jquery","underscore","annotator_1.2.9"],function(t,e,n){var o,i,r,s,a=[];return o=function(){a=[]},s=function(t,e){a.push(t),r(e)},r=function(r){var s,u,l;r===a.length&&(s={data:{user:a[0].params.user,course_id:a[0].params.courseId},type:"GET",dataType:"json",headers:{"x-annotator-auth-token":a[0].params.token}},l=a[0].params.endpoint+"search/?",u=e.map(a,function(t){return"usage_id="+encodeURIComponent(t.params.usageId)}),l+=u.join("&"),t.ajax(l,s).done(function(t){i(t)}).fail(function(t){t._action="search",n.Plugin.Store.prototype._onError(t)}).always(function(){o()}))},i=function(t){var n={};e.each(a,function(t){n[t.params.usageId]={rows:[]}}),e.each(t,function(t){n[t.usage_id].rows.push(t)}),e.each(a,function(t){t.annotator.plugins.Store._onLoadAnnotationsFromSearch(n[t.params.usageId])})},{storeNotesRequestData:s,cleanup:o}})}.call(this,define||RequireJS.define),function(){RequireJS.define("js/edxnotes/utils/utils",[],function(){var t=function(t){return(t+"").replace(/(\r\n|\n\r|\r|\n)/g,"<br>")};return{nl2br:t}})}.call(this,define||RequireJS.define),function(){RequireJS.define("js/edxnotes/views/shim",["jquery","underscore","annotator_1.2.9","js/edxnotes/utils/utils"],function(t,e,n,o){var i=n._t;n.prototype._setupDynamicStyle=function(){},n.frozenSrc=null,n.Plugin.Auth.prototype.haveValidToken=function(){return this._unsafeToken&&this._unsafeToken.sub&&this._unsafeToken.exp&&this._unsafeToken.iat&&this.timeToExpiry()>0},n.Plugin.Auth.prototype.timeToExpiry=function(){var t=(new Date).getTime()/1e3,e=this._unsafeToken.exp,n=e-t;return n>0?n:0},n.Plugin.Tags.prototype.updateField=e.compose(function(){var e=t("li.annotator-item >input",this.annotator.editor.element).attr("id");return 0===t("label.sr[for='"+e+"']",this.annotator.editor.element).length&&t('<label class="sr" for='+e+">"+i("Tags (space-separated)")+"</label>").insertBefore(t("#"+e,this.annotator.editor.element)),this},n.Plugin.Tags.prototype.updateField),n.Plugin.Tags.prototype.updateViewer=e.compose(function(){return t("div.annotator-tags",this.wrapper).attr({role:"region","aria-label":"tags"}),this},n.Plugin.Tags.prototype.updateViewer),n.prototype.highlightRange=e.compose(function(e){return t(".annotator-hl",this.wrapper).attr({tabindex:0,role:"link"}),e},n.prototype.highlightRange),n.prototype.destroy=e.compose(n.prototype.destroy,function(){this===n.frozenSrc?this.unfreezeAll():(t(document).off("click.edxnotes:freeze"+this.uid),this.isFrozen=!1),this.logger&&this.logger.destroy&&this.logger.destroy(),this.viewer.element.off("click",this.onNoteClick),this.wrapper.off("click",".annotator-hl")}),n.Viewer.prototype.html={element:['<div class="annotator-outer annotator-viewer">','<ul class="annotator-widget annotator-listing" tabindex="-1"></ul>',"</div>"].join(""),item:['<li class="annotator-annotation annotator-item">','<span class="annotator-controls">','<a href="#" title="',i("View as webpage"),'" class="annotator-link">',i("View as webpage"),"</a>",'<button class="annotator-edit">',i("Edit"),'<span class="sr">',i("Note"),"</span>","</button>",'<button class="annotator-delete">',i("Delete"),'<span class="sr">',i("Note"),"</span>","</button>",'<button class="annotator-close">',i("Close"),'<span class="sr">',i("Note"),"</span>","</button>","</span>","</li>"].join("")},n.prototype._setupViewer=function(){var r=this;return this.viewer=new n.Viewer({readOnly:this.options.readOnly}),this.viewer.element.on("click",e.bind(this.onNoteClick,this)),this.viewer.hide().on("edit",this.onEditAnnotation).on("delete",this.onDeleteAnnotation).addField({load:function(e,s){return t(e).html(s.text?o.nl2br(n.Util.escape(s.text)):"<i>"+i("No Comment")+"</i>"),r.publish("annotationViewerTextField",[e,s])}}).element.appendTo(this.wrapper).bind({mouseover:this.clearViewerHideTimer,mouseout:this.startViewerHideTimer}),this},n.Editor.prototype.isShown=n.Viewer.prototype.isShown,n.Editor.prototype.html=['<div class="annotator-outer annotator-editor">','<form class="annotator-widget" tabindex="-1">','<ul class="annotator-listing"></ul>','<div class="annotator-controls">','<button class="annotator-save">',i("Save"),'<span class="sr">',i("Note"),"</span>","</button>",'<button class="annotator-cancel">',i("Cancel"),'<span class="sr">',i("Note"),"</span>","</button>","</div>","</form>","</div>"].join(""),n.Editor.prototype.show=e.compose(function(e){var n=t("li.annotator-item >textarea",this.element).attr("id");0===t("label.sr[for='"+n+"']",this.element).length&&t('<label class="sr" for='+n+">"+i("Note")+"</label>").insertBefore(t("#"+n,this.element)),"keydown"===e.type&&(this.element.find(".annotator-save").removeClass(this.classes.focus),this.element.find("form.annotator-widget").focus())},n.Editor.prototype.show),delete n.Editor.prototype.events["textarea keydown"],n.prototype.onHighlightMouseover=e.wrap(n.prototype.onHighlightMouseover,function(t,e){return this.editor.isShown()?!1:t.call(this,e)},n.prototype._setupViewer),n.prototype._setupWrapper=e.compose(function(){return this.element.on("click",".annotator-hl",e.bind(this.onHighlightClick,this)),this},n.prototype._setupWrapper),t.extend(!0,n.prototype,{isFrozen:!1,uid:e.uniqueId(),onHighlightClick:function(t){t.stopPropagation(),this.editor.isShown()||(this.unfreezeAll(),this.onHighlightMouseover.call(this,t),n.frozenSrc=this,this.freezeAll())},onNoteClick:function(e){var o=t(e.target);e.stopPropagation(),n.Util.preventEventDefault(e),o.is(".annotator-delete")||o.is(".annotator-close")?o.is(".annotator-close")&&this.viewer.hide():(n.frozenSrc=this,this.freezeAll())},freeze:function(){return this.isFrozen||(this.removeEvents(),this.viewer.element.unbind("mouseover mouseout"),this.uid=e.uniqueId(),t(document).on("click.edxnotes:freeze"+this.uid,e.bind(this.unfreeze,this)),this.isFrozen=!0),this
},unfreeze:function(){return this.isFrozen&&(this.addEvents(),this.viewer.element.bind({mouseover:this.clearViewerHideTimer,mouseout:this.startViewerHideTimer}),this.viewer.hide(),t(document).off("click.edxnotes:freeze"+this.uid),this.isFrozen=!1,n.frozenSrc=null),this},freezeAll:function(){return e.invoke(n._instances,"freeze"),this},unfreezeAll:function(){return e.invoke(n._instances,"unfreeze"),this},showFrozenViewer:function(t,e){return this.showViewer(t,e),this.freezeAll(),this}})})}.call(this,define||RequireJS.define),function(){RequireJS.define("js/edxnotes/plugins/scroller",["jquery","underscore","annotator_1.2.9"],function(t,e,n){n.Plugin.Scroller=function(){n.Plugin.apply(this,arguments)},t.extend(n.Plugin.Scroller.prototype,new n.Plugin,{getIdFromLocationHash:function(){return window.location.hash.substr(1)},pluginInit:function(){e.bindAll(this,"onNotesLoaded"),this.getIdFromLocationHash()&&this.annotator.subscribe("annotationsLoaded",this.onNotesLoaded)},destroy:function(){this.annotator.unsubscribe("annotationsLoaded",this.onNotesLoaded)},onNotesLoaded:function(n){var o=this.getIdFromLocationHash();this.annotator.logger.log("Scroller",{"notes:":n,hash:o}),e.each(n,function(e){var n,i;e.id===o&&e.highlights.length&&(window.location.hash="",n=t(e.highlights[0]),i=n.position(),this.annotator.showFrozenViewer([e],{top:i.top+.5*n.height(),left:i.left+.5*n.width()}),this.annotator.freezeAll(),this.scrollIntoView(n))},this)},scrollIntoView:function(t){t.focus()}})})}.call(this,define||RequireJS.define),function(){RequireJS.define("js/edxnotes/plugins/events",["underscore","annotator_1.2.9"],function(t,e){e.Plugin.Store.prototype.annotationCreated=t.compose(function(e){return e.done(t.bind(function(t){t&&t.id&&this.publish("annotationFullyCreated",t)},this))},e.Plugin.Store.prototype.annotationCreated),e.Plugin.Events=function(){e.Plugin.apply(this,arguments)},t.extend(e.Plugin.Events.prototype,new e.Plugin,{pluginInit:function(){t.bindAll(this,"annotationViewerShown","annotationFullyCreated","annotationEditorShown","annotationEditorHidden","annotationUpdated","annotationDeleted"),this.annotator.subscribe("annotationViewerShown",this.annotationViewerShown).subscribe("annotationFullyCreated",this.annotationFullyCreated).subscribe("annotationEditorShown",this.annotationEditorShown).subscribe("annotationEditorHidden",this.annotationEditorHidden).subscribe("annotationUpdated",this.annotationUpdated).subscribe("annotationDeleted",this.annotationDeleted)},destroy:function(){this.annotator.unsubscribe("annotationViewerShown",this.annotationViewerShown).unsubscribe("annotationFullyCreated",this.annotationFullyCreated).unsubscribe("annotationEditorShown",this.annotationEditorShown).unsubscribe("annotationEditorHidden",this.annotationEditorHidden).unsubscribe("annotationUpdated",this.annotationUpdated).unsubscribe("annotationDeleted",this.annotationDeleted)},annotationViewerShown:function(e,n){var o;n=t.reject(n,this.isNew),o={notes:t.map(n,function(t){return{note_id:t.id}})},o.notes.length&&this.log("edx.course.student_notes.viewed",o)},annotationFullyCreated:function(t){var e=this.getDefaultData(t);this.log("edx.course.student_notes.added",e)},annotationEditorShown:function(t,e){this.oldNoteText=e.text||"",this.oldTags=e.tags||[]},annotationEditorHidden:function(){this.oldNoteText=null,this.oldTags=null},annotationUpdated:function(e){var n,o;this.isNew(e)||(o=this.getDefaultData(e),n=t.extend(o,this.getText("old_note_text",this.oldNoteText,o.truncated),this.getTextArray("old_tags",this.oldTags,o.truncated)),this.log("edx.course.student_notes.edited",n))},annotationDeleted:function(t){var e;this.isNew(t)||(e=this.getDefaultData(t),this.log("edx.course.student_notes.deleted",e))},getDefaultData:function(e){var n=[];return t.extend({note_id:e.id,component_usage_id:e.usage_id,truncated:n},this.getText("note_text",e.text,n),this.getText("highlighted_content",e.quote,n),this.getTextArray("tags",e.tags,n))},getText:function(e,n,o){var i={},r=this.options.stringLimit;return t.isNumber(r)&&t.isString(n)&&n.length>r&&(n=String(n).slice(0,r),o.push(e)),i[e]=n,i},getTextArray:function(e,n,o){var i,r={},s=this.options.stringLimit,a=0,u=[];if(t.isNumber(s)&&t.isArray(n))for(i=0;i<n.length;i++){if(t.isString(n[i])&&a+n[i].length>s){o.push(e);break}a+=n[i].length,u[i]=n[i]}else u=n;return r[e]=u,r},isNew:function(e){return!t.has(e,"id")},log:function(t,e){this.annotator.logger.emit(t,e)}})})}.call(this,define||RequireJS.define),function(){RequireJS.define("js/edxnotes/plugins/accessibility",["jquery","underscore","annotator_1.2.9"],function(t,e,n){n.Plugin.Accessibility=function(){e.bindAll(this,"addAriaAttributes","onHighlightKeyDown","onViewerKeyDown","onEditorKeyDown","addDescriptions","removeDescription","focusOnGrabber","showViewer","onClose","focusOnHighlightedText"),n.Plugin.apply(this,arguments)},t.extend(n.Plugin.Accessibility.prototype,new n.Plugin,{pluginInit:function(){this.annotator.subscribe("annotationViewerTextField",this.addAriaAttributes),this.annotator.subscribe("annotationsLoaded",this.addDescriptions),this.annotator.subscribe("annotationCreated",this.addDescriptions),this.annotator.subscribe("annotationCreated",this.focusOnHighlightedText),this.annotator.subscribe("annotationDeleted",this.removeDescription),this.annotator.element.on("keydown.accessibility.hl",".annotator-hl",this.onHighlightKeyDown),this.annotator.element.on("keydown.accessibility.viewer",".annotator-viewer",this.onViewerKeyDown),this.annotator.element.on("keydown.accessibility.editor",".annotator-editor",this.onEditorKeyDown),this.addFocusGrabber(),this.addTabIndex()},destroy:function(){this.annotator.unsubscribe("annotationViewerTextField",this.addAriaAttributes),this.annotator.unsubscribe("annotationsLoaded",this.addDescriptions),this.annotator.unsubscribe("annotationCreated",this.addDescriptions),this.annotator.unsubscribe("annotationCreated",this.focusOnHighlightedText),this.annotator.unsubscribe("annotationDeleted",this.removeDescription),this.annotator.element.off(".accessibility"),this.removeFocusGrabber()},addTabIndex:function(){this.annotator.element.find(".annotator-edit, .annotator-delete").attr("tabindex",0)},addFocusGrabber:function(){this.focusGrabber=t("<span />",{"class":"edx-notes-focus-grabber",tabindex:"-1"}),this.annotator.wrapper.before(this.focusGrabber)},removeFocusGrabber:function(){this.focusGrabber&&(this.focusGrabber.remove(),this.focusGrabber=null)},focusOnGrabber:function(){this.annotator.wrapper.siblings(".edx-notes-focus-grabber").focus()},addDescriptions:function(o){e.isArray(o)||(o=[o]),e.each(o,function(o){var i=o.id||e.uniqueId();this.annotator.wrapper.after(t("<div />",{"class":"aria-note-description sr",id:"aria-note-description-"+i,text:n.Util.escape(o.text)})),t(o.highlights).attr({"aria-describedby":"aria-note-description-"+i})},this)},removeDescription:function(e){var n=t(e.highlights).attr("aria-describedby");t("#"+n).remove()},addAriaAttributes:function(e){t(e).attr({tabindex:-1,role:"note","class":"annotator-note"})},focusOnHighlightedText:function(){var t,e=this.annotator.viewer,n=this.annotator.editor;try{e.isShown()?t=e.annotations[0].highlights[0]:n.isShown()&&(t=n.annotation.highlights[0]),t.focus()}catch(o){}},getViewerTabControls:function(){var t,e,n,o,i,r,s=[];return t=this.annotator.element.find(".annotator-viewer"),e=t.find(".annotator-note"),n=t.find(".annotator-controls"),o=n.find(".annotator-edit"),i=n.find(".annotator-delete"),r=n.find(".annotator-close"),s.push(e,o,i,r),s},getEditorTabControls:function(){var t,e,n,o,i,r,s=[],a=null;return t=this.annotator.element.find(".annotator-editor"),e=t.find(".annotator-controls"),r=t.find(".annotator-listing").find(".annotator-item"),n=r.first().children("textarea"),o=e.find(".annotator-save"),i=e.find(".annotator-cancel"),r.length>1&&(a=r.first().next().children("input")),s.push(n),a&&s.push(a),s.push(o,i),s},focusOnNextTabControl:function(t,n){var o;e.each(t,function(e,i){e.is(n)&&(o=i===t.length-1?0:i+1,t[o].focus())})},focusOnPreviousTabControl:function(t,n){var o;e.each(t,function(e,i){e.is(n)&&(o=0===i?t.length-1:i-1,t[o].focus())})},showViewer:function(e,n){n=t.makeArray(n),this.annotator.showViewer(n,e),this.annotator.element.find(".annotator-listing").focus(),this.annotator.subscribe("annotationDeleted",this.focusOnGrabber)},onClose:function(){this.focusOnHighlightedText(),this.annotator.unsubscribe("annotationDeleted",this.focusOnGrabber)},onHighlightKeyDown:function(e){var n,o=t.ui.keyCode,i=e.keyCode,r=t(e.currentTarget);switch(i){case o.TAB:this.annotator.viewer.isShown()&&(this.annotator.element.find(".annotator-listing").focus(),e.preventDefault(),e.stopPropagation());break;case o.ENTER:case o.SPACE:this.annotator.viewer.isShown()||(n=r.position(),this.showViewer(n,r.data("annotation")),e.preventDefault(),e.stopPropagation());break;case o.ESCAPE:this.annotator.viewer.hide(),e.preventDefault(),e.stopPropagation()}},onViewerKeyDown:function(n){var o,i=t.ui.keyCode,r=n.keyCode,s=t(n.target),a=this.annotator.element.find(".annotator-listing");switch(r){case i.TAB:o=this.getViewerTabControls(),n.shiftKey?s.is(a)?e.last(o).focus():this.focusOnPreviousTabControl(o,s):s.is(a)?e.first(o).focus():this.focusOnNextTabControl(o,s),n.preventDefault(),n.stopPropagation();break;case i.ENTER:case i.SPACE:s.hasClass("annotator-close")&&(this.onClose(),this.annotator.viewer.hide(),n.preventDefault());break;case i.ESCAPE:this.onClose(),this.annotator.viewer.hide(),n.preventDefault()}},onEditorKeyDown:function(n){var o,i,r,s,a,u,l=t.ui.keyCode,h=n.keyCode,d=t(n.target);switch(o=this.annotator.element.find(".annotator-editor"),i=o.find(".annotator-widget"),r=o.find(".annotator-controls"),s=r.find(".annotator-save"),a=r.find(".annotator-cancel"),h){case l.TAB:u=this.getEditorTabControls(),n.shiftKey?d.is(i)?e.last(u).focus():this.focusOnPreviousTabControl(u,d):d.is(i)?e.first(u).focus():this.focusOnNextTabControl(u,d),n.preventDefault(),n.stopPropagation();break;case l.ENTER:if(d.is(s)||n.metaKey||n.ctrlKey)this.onClose(),this.annotator.editor.submit();else{if(!d.is(a))break;this.onClose(),this.annotator.editor.hide()}n.preventDefault();break;case l.SPACE:if(d.is(s))this.onClose(),this.annotator.editor.submit();else{if(!d.is(a))break;this.onClose(),this.annotator.editor.hide()}n.preventDefault();break;case l.ESCAPE:this.onClose(),this.annotator.editor.hide(),n.preventDefault()}}})})}.call(this,define||RequireJS.define),function(){RequireJS.define("js/edxnotes/plugins/caret_navigation",["jquery","underscore","annotator_1.2.9"],function(t,e,n){n.Plugin.CaretNavigation=function(){e.bindAll(this,"onKeyUp"),n.Plugin.apply(this,arguments)},t.extend(n.Plugin.CaretNavigation.prototype,new n.Plugin,{pluginInit:function(){t(document).on("keyup",this.onKeyUp)},destroy:function(){t(document).off("keyup",this.onKeyUp)},isShortcut:function(t){return 221===t.keyCode&&t.ctrlKey&&t.shiftKey},hasSelection:function(t){return(t||[]).length},saveSelection:function(){this.savedRange=n.Util.getGlobal().getSelection().getRangeAt(0)},restoreSelection:function(){if(this.savedRange){var t=new n.Range.BrowserRange(this.savedRange),e=t.normalize().limit(this.annotator.wrapper[0]);n.Util.readRangeViaSelection(e),this.savedRange=null}},onKeyUp:function(n){var o,i,r,s,a,u,l,h=this.annotator,d=this;return this.isShortcut(n)?(h.selectedRanges=h.getSelectedRanges(),this.hasSelection(h.selectedRanges)?(o=e.some(h.selectedRanges,function(t){return h.isAnnotator(t.commonAncestor)}))?!0:(i=h.setupAnnotation(h.createAnnotation()),r=t(i.highlights).addClass("annotator-hl-temporary"),h.adder.is(":visible")?(s=h.adder.position(),h.adder.hide()):s=r.last().position(),a=function(){l(),r.removeClass("annotator-hl-temporary"),h.publish("annotationCreated",[i])},u=function(){d.restoreSelection(),l(),h.deleteAnnotation(i)},l=function(){h.unsubscribe("annotationEditorHidden",u),h.unsubscribe("annotationEditorSubmit",a),d.savedRange=null},h.subscribe("annotationEditorHidden",u),h.subscribe("annotationEditorSubmit",a),this.saveSelection(),h.showEditor(i,s),void n.preventDefault()):!0):!0}})})}.call(this,define||RequireJS.define),function(){RequireJS.define("js/edxnotes/plugins/store_error_handler",["annotator_1.2.9"],function(t){var e=t.Plugin.Store.prototype._onError;t.Plugin.Store.prototype._onError=function(n){var o;if(n.responseText)try{o=JSON.parse(n.responseText)}catch(i){o=null}return o&&o.error_msg?(t.showNotification(o.error_msg,t.Notification.ERROR),console.error(t._t("API request failed:")+(" '"+n.status+"'"))):void e(n)}})}.call(this,define||RequireJS.define),function(){RequireJS.define("js/edxnotes/plugins/search_override",["annotator_1.2.9"],function(t){t.Plugin.Store.prototype._getAnnotations=function(){}})}.call(this,define||RequireJS.define),function(){RequireJS.define("js/edxnotes/views/notes_factory",["jquery","underscore","annotator_1.2.9","js/edxnotes/utils/logger","js/edxnotes/utils/notes_collector","js/edxnotes/views/shim","js/edxnotes/plugins/scroller","js/edxnotes/plugins/events","js/edxnotes/plugins/accessibility","js/edxnotes/plugins/caret_navigation","js/edxnotes/plugins/store_error_handler","js/edxnotes/plugins/search_override"],function(t,e,n,o,i){var r,s,a,u=["Auth","Store","Scroller","Events","Accessibility","CaretNavigation","Tags"];return r=function(t,e){var n={user:e.user,usage_id:e.usageId,course_id:e.courseId},o=e.endpoint.replace(/(.+)\/$/,"$1");return{auth:{token:e.token,tokenUrl:e.tokenUrl},events:{stringLimit:e.eventStringLimit},store:{prefix:o,annotationData:n,loadFromSearch:n,urls:{create:"/annotations/",read:"/annotations/:id/",update:"/annotations/:id/",destroy:"/annotations/:id/",search:"/search/"}}}},s=function(t,n,o){e.each(n,function(e){var n=o[e.toLowerCase()];t.addPlugin(e,n)},this)},a=function(e,n){var a,l=t(e),h=r(l,n),d=o.getLogger(e.id,n.debug);return a=l.annotator(h).data("annotator"),s(a,u,h),i.storeNotesRequestData({annotator:a,params:n},t(".edx-notes-wrapper").length),a.logger=d,d.log({element:e,options:h}),a},{factory:a}})}.call(this,define||RequireJS.define),function(){RequireJS.define("js/edxnotes/views/visibility_decorator",["jquery","underscore","js/edxnotes/views/notes_factory"],function(t,e,n){var o,i,r,s,a={},u=null;return o=function(){return e.map(t(".edx-notes-wrapper"),function(t){return t.id})},i=function(t,e){return e?n.factory(t,e):null},r=function(t){var n=e.clone(Annotator._instances);t=t||[],e.each(n,function(n){var o=n.element.attr("id");e.contains(t,o)||n.destroy()})},s=function(t,n,s){return a[t.id]=n,e.isNull(u)&&(u=s),u?(r(o()),i(t,n)):null},{factory:s,enableNote:function(t){i(t,a[t.id]),u=!0},disableNotes:function(){r(),u=!1},_setVisibility:function(t){u=t}}})}.call(this,define||RequireJS.define),function(){this.AnimationUtil=function(){function t(){}return t.triggerAnimation=function(t){t.removeClass("is-fleeting"),t.offset().width=t.offset().width,t.addClass("is-fleeting")},t}.call(this)}.call(this),RequireJS.define("js/utils/animation",function(){}),function(){RequireJS.define("js/edxnotes/views/notes_visibility_factory",["jquery","underscore","backbone","gettext","annotator_1.2.9","js/edxnotes/views/visibility_decorator","js/utils/animation"],function(t,e,n,o,i,r){var s=n.View.extend({events:{"click .action-toggle-notes":"toggleHandler"},errorMessage:o("An error has occurred. Make sure that you are connected to the Internet, and then try refreshing the page."),initialize:function(n){e.bindAll(this,"onSuccess","onError","keyDownToggleHandler"),this.visibility=n.visibility,this.visibilityUrl=n.visibilityUrl,this.label=this.$(".utility-control-label"),this.actionLink=this.$(".action-toggle-notes"),this.actionLink.removeClass("is-disabled"),this.actionToggleMessage=this.$(".action-toggle-message"),this.notification=new i.Notification,t(document).on("keydown.edxnotes:togglenotes",this.keyDownToggleHandler)},remove:function(){t(document).off("keydown.edxnotes:togglenotes"),n.View.prototype.remove.call(this)},toggleHandler:function(t){t.preventDefault(),this.visibility=!this.visibility,AnimationUtil.triggerAnimation(this.actionToggleMessage),this.toggleNotes(this.visibility)},keyDownToggleHandler:function(t){219===t.keyCode&&t.ctrlKey&&t.shiftKey&&this.toggleHandler(t)},toggleNotes:function(t){t?this.enableNotes():this.disableNotes(),this.sendRequest()},enableNotes:function(){e.each(t(".edx-notes-wrapper"),r.enableNote),this.actionLink.addClass("is-active"),this.label.text(o("Hide notes")),this.actionToggleMessage.text(o("Notes visible"))},disableNotes:function(){r.disableNotes(),this.actionLink.removeClass("is-active"),this.label.text(o("Show notes")),this.actionToggleMessage.text(o("Notes hidden"))},hideErrorMessage:function(){this.notification.hide()},showErrorMessage:function(t){this.notification.show(t,i.Notification.ERROR)},sendRequest:function(){return t.ajax({type:"PUT",url:this.visibilityUrl,dataType:"json",data:JSON.stringify({visibility:this.visibility}),success:this.onSuccess,error:this.onError})},onSuccess:function(){this.hideErrorMessage()},onError:function(){this.showErrorMessage(this.errorMessage)}});return{ToggleVisibilityView:function(e,n){return new s({el:t(".edx-notes-visibility").get(0),visibility:e,visibilityUrl:n})},VisibilityDecorator:r}})}.call(this,define||RequireJS.define);